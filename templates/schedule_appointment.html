{% extends "base.html" %}

{% block title %}Schedule Appointment - SmartHire AI{% endblock %}

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<!-- Flatpickr for datetime picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .fc {
        background-color: var(--card-bg);
        border-radius: 0.5rem;
        padding: 1rem;
    }
    
    .fc-toolbar {
        color: var(--text-color);
    }
    
    .fc-toolbar-title {
        color: var(--text-color) !important;
    }
    
    .fc-col-header-cell {
        background-color: var(--bg-color);
    }
    
    .fc-daygrid-day {
        background-color: var(--card-bg);
    }
    
    .fc-day-today {
        background-color: rgba(123, 44, 191, 0.1) !important;
    }
    
    .fc-event {
        cursor: pointer;
        padding: 2px 4px;
        font-size: 0.8rem;
    }
    
    #appointmentModal .modal-content {
        background-color: var(--card-bg);
        color: var(--text-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Interview Schedule</h1>
            <p class="text-muted mb-0">Schedule and manage candidate interviews</p>
        </div>
        <div>
            <button class="btn btn-outline-secondary me-2" id="toggleViewBtn">
                <i class="fas fa-list me-1"></i> List View
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#appointmentModal" id="newAppointmentBtn">
                <i class="fas fa-plus me-2"></i>New Appointment
            </button>
        </div>
    </div>
    
    <div class="row">
        <!-- Calendar View -->
        <div class="col-lg-8 mb-4" id="calendarView">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Interview Calendar</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="prevBtn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="todayBtn">Today</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="nextBtn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
        
        <!-- Upcoming Interviews -->
        <div class="col-lg-4" id="upcomingInterviews">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">Upcoming Interviews</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% if appointments %}
                            {% for appt in appointments %}
                            <div class="list-group-item list-group-item-action border-0 py-3">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ appt.title }}</h6>
                                    <small class="text-muted">{{ appt.start_time.strftime('%b %d') }}</small>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-user me-2 text-muted"></i>
                                    <small>{{ candidate.name }}</small>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <i class="far fa-clock me-2 text-muted"></i>
                                    <small>{{ appt.start_time.strftime('%I:%M %p') }} - {{ appt.end_time.strftime('%I:%M %p') }}</small>
                                </div>
                                {% if appt.meeting_link %}
                                <a href="{{ appt.meeting_link }}" target="_blank" class="btn btn-sm btn-outline-primary w-100 mt-2">
                                    <i class="fas fa-video me-1"></i> Join Meeting
                                </a>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5 text-muted">
                                <i class="far fa-calendar-alt fa-3x mb-3"></i>
                                <p class="mb-0">No upcoming interviews</p>
                                <small>Schedule a new interview to get started</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <button class="btn btn-outline-secondary w-100" data-bs-toggle="modal" data-bs-target="#mockInterviewModal">
                        <i class="fas fa-magic me-2"></i>Schedule Mock Interview
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Appointment Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="appointmentModalLabel">Schedule New Appointment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="appointmentForm" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <input type="hidden" id="appointmentId">
                    <input type="hidden" id="candidateId" value="{{ candidate_id }}">
                    
                    <div class="mb-3">
                        <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="title" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startTime" class="form-label">Start Time <span class="text-danger">*</span></label>
                            <input type="text" class="form-control bg-dark text-white border-secondary" id="startTime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endTime" class="form-label">End Time <span class="text-danger">*</span></label>
                            <input type="text" class="form-control bg-dark text-white border-secondary" id="endTime" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control bg-dark text-white border-secondary" id="description" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="location">
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingLink" class="form-label">Meeting Link (if online)</label>
                        <input type="url" class="form-control bg-dark text-white border-secondary" id="meetingLink">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveAppointment">Save Appointment</button>
                    <button type="button" class="btn btn-danger d-none" id="deleteAppointment">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Mock Interview Modal -->
<div class="modal fade" id="mockInterviewModal" tabindex="-1" aria-labelledby="mockInterviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mockInterviewModalLabel">Schedule Mock Interview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Select a mock interview template to schedule with {{ candidate.name }}.
                </div>
                <div class="list-group" id="mockInterviewList">
                    <!-- Mock interview templates will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Moment.js for date handling -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<script>
// Mock interview data
const mockInterviews = [
    {
        id: 'mock1',
        title: 'Technical Screening',
        duration: 45,
        description: 'Standard technical screening with coding challenges',
        skills: ['Algorithms', 'Data Structures', 'Problem Solving']
    },
    {
        id: 'mock2',
        title: 'System Design',
        duration: 60,
        description: 'System design and architecture discussion',
        skills: ['System Design', 'Scalability', 'Databases']
    },
    {
        id: 'mock3',
        title: 'Behavioral Interview',
        duration: 30,
        description: 'Cultural fit and behavioral questions',
        skills: ['Communication', 'Teamwork', 'Problem Solving']
    }
];

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Flatpickr for datetime inputs
    const dateOptions = {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        time_24hr: true,
        minDate: "today",
        theme: "dark"
    };
    
    const startTimePicker = flatpickr("#startTime", dateOptions);
    const endTimePicker = flatpickr("#endTime", {
        ...dateOptions,
        minDate: "today"
    });
    
    // Initialize calendar
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        themeSystem: 'bootstrap5',
        events: '/api/appointments',
        eventClick: function(info) {
            // When an event is clicked, open the edit modal
            const event = info.event;
            const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
            
            // Set form values
            document.getElementById('appointmentId').value = event.id;
            document.getElementById('title').value = event.title;
            document.getElementById('description').value = event.extendedProps.description || '';
            document.getElementById('location').value = event.extendedProps.location || '';
            document.getElementById('meetingLink').value = event.extendedProps.meeting_link || '';
            
            // Set datetime values
            startTimePicker.setDate(event.start);
            endTimePicker.setDate(event.end || event.start);
            
            // Show delete button
            document.getElementById('deleteAppointment').classList.remove('d-none');
            
            // Update modal title and show
            document.getElementById('appointmentModalLabel').textContent = 'Edit Appointment';
            modal.show();
        },
        eventContent: function(arg) {
            // Custom event rendering
            const eventEl = document.createElement('div');
            eventEl.className = 'fc-event-main';
            eventEl.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 me-2">
                        <i class="fas fa-video" style="color: #fff;"></i>
                    </div>
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="text-truncate fw-bold">${arg.event.title}</div>
                        <div class="small">
                            ${arg.timeText} • ${arg.event.extendedProps.location || 'No location'}
                        </div>
                    </div>
                </div>
            `;
            return { domNodes: [eventEl] };
        }
    });
    
    // Initialize calendar
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        if (!calendarEl) {
            console.error('Calendar element not found');
            return;
        }

        // Prepare events data using JSON string and parse it
        const eventsData = JSON.parse(`[
            {%- for appt in appointments -%}
            {
                "id": "{{ appt.id | tojson | safe }}",
                "title": "{{ appt.title | replace('"', '\\"') | safe }}",
                "start": "{{ appt.start_time.isoformat() }}",
                "end": "{{ appt.end_time.isoformat() }}",
                "location": "{{ appt.location | default('') | replace('"', '\\"') | safe }}",
                "meetingLink": "{{ appt.meeting_link | default('') | replace('"', '\\"') | safe }}",
                "description": "{{ appt.description | default('') | replace('"', '\\"') | safe }}",
                "status": "{{ appt.status | default('scheduled') | safe }}"
            }{% if not loop.last %},{% endif %}
            {%- endfor -%}
        ]`);

        // Initialize the calendar
        window.calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: eventsData,
            eventClick: function(info) {
                try {
                    const event = info.event;
                    const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
                    
                    document.getElementById('appointmentId').value = event.id || '';
                    document.getElementById('title').value = event.title || '';
                    document.getElementById('description').value = event.extendedProps?.description || '';
                    document.getElementById('location').value = event.extendedProps?.location || '';
                    document.getElementById('meetingLink').value = event.extendedProps?.meetingLink || '';
                    
                    // Format dates for flatpickr
                    if (window.startTimePicker && event.start) {
                        window.startTimePicker.setDate(event.start);
                    }
                    if (window.endTimePicker && (event.end || event.start)) {
                        window.endTimePicker.setDate(event.end || event.start);
                    }
                    
                    document.getElementById('appointmentModalLabel').textContent = 'Edit Appointment';
                    const deleteBtn = document.getElementById('deleteAppointment');
                    if (deleteBtn) {
                        deleteBtn.classList.remove('d-none');
                    }
                    
                    modal.show();
                } catch (error) {
                    console.error('Error handling event click:', error);
                }
            },
            eventContent: function(arg) {
                const eventEl = document.createElement('div');
                eventEl.className = 'fc-event-main';
                eventEl.innerHTML = `
                    <div class="fc-event-title">${arg.event.title}</div>
                    <div class="small">
                        ${arg.timeText} • ${arg.event.extendedProps.location || 'No location'}
                    </div>
                `;
                return { domNodes: [eventEl] };
            }
        });
        
        window.calendar.render();
        
        // Navigation controls
        document.getElementById('prevBtn').addEventListener('click', () => {
            window.calendar.prev();
        });
        
        document.getElementById('nextBtn').addEventListener('click', () => {
            window.calendar.next();
        });
        
        document.getElementById('todayBtn').addEventListener('click', () => {
            window.calendar.today();
        });
        
        // Toggle between calendar and list view
        let isListView = false;
        document.getElementById('toggleViewBtn').addEventListener('click', () => {
            isListView = !isListView;
            const calendarView = document.getElementById('calendarView');
            const upcomingView = document.getElementById('upcomingInterviews');
            const btnIcon = document.querySelector('#toggleViewBtn i');
            
            if (isListView) {
                calendarView.classList.remove('col-lg-8');
                calendarView.classList.add('d-none');
                upcomingView.classList.remove('col-lg-4');
                upcomingView.classList.add('col-12');
            btnIcon.className = 'fas fa-calendar-alt me-1';
            document.querySelector('#toggleViewBtn span').textContent = 'Calendar View';
        } else {
            calendarView.classList.remove('d-none');
            calendarView.classList.add('col-lg-8');
            upcomingView.classList.remove('col-12');
            upcomingView.classList.add('col-lg-4');
            btnIcon.className = 'fas fa-list me-1';
            document.querySelector('#toggleViewBtn span').textContent = 'List View';
        }
    });
    
    // Initialize mock interview modal
    const mockInterviewModal = new bootstrap.Modal(document.getElementById('mockInterviewModal'));
    const mockInterviewContainer = document.getElementById('mockInterviewList');
    
    // Populate mock interview options
    if (mockInterviewContainer) {
        mockInterviews.forEach(interview => {
            const item = document.createElement('div');
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${interview.title}</h6>
                    <small class="text-muted">${interview.duration} min</small>
                </div>
                <p class="mb-1 small text-muted">${interview.description}</p>
                <div class="mt-2">
                    ${interview.skills.map(skill => `<span class="badge bg-light text-dark me-1 mb-1">${skill}</span>`).join('')}
                </div>
                <button class="btn btn-sm btn-outline-primary w-100 mt-2 schedule-mock-btn" data-interview-id="${interview.id}">
                    Schedule This Interview
                </button>
            `;
            mockInterviewContainer.appendChild(item);
        });
    }
    
    // Function to handle mock interview scheduling
    function scheduleMockInterview(interviewId) {
        const interview = mockInterviews.find(i => i.id === interviewId);
        
        if (!interview) return;

        // Set default time (next business day at 10 AM)
        const now = new Date();
        const defaultStart = new Date(now);
        
        // Set to next business day (Mon-Fri)
        const day = defaultStart.getDay();
        const daysToAdd = day === 5 ? 3 : day === 6 ? 2 : 1;
        defaultStart.setDate(defaultStart.getDate() + daysToAdd);
        defaultStart.setHours(10, 0, 0, 0);
        
        const defaultEnd = new Date(defaultStart);
        defaultEnd.setMinutes(defaultStart.getMinutes() + interview.duration);
        
        // Reset form
        const form = document.getElementById('appointmentForm');
        form.reset();
        
        // Set form values
        document.getElementById('title').value = `${interview.title} - ${candidate.name}`;
        document.getElementById('description').value = interview.description;
        document.getElementById('appointmentId').value = '';
        document.getElementById('deleteAppointment').classList.add('d-none');
        
        // Set the date pickers
        if (window.startTimePicker && window.endTimePicker) {
            window.startTimePicker.setDate(defaultStart);
            window.endTimePicker.setDate(defaultEnd);
        }
        
        // Update modal title
        document.getElementById('appointmentModalLabel').textContent = 'Schedule Mock Interview';
        
        // Close mock interview modal if open
        if (window.mockInterviewModal) {
            window.mockInterviewModal.hide();
        }
        
        // Show the appointment modal
        const appointmentModal = new bootstrap.Modal(document.getElementById('appointmentModal'));
        appointmentModal.show();
        
        // Focus the first input field
        setTimeout(() => {
            const firstInput = document.querySelector('#appointmentModal input');
            if (firstInput) firstInput.focus();
        }, 500);
    }
    
    // Function to handle mock interview button clicks
    function handleMockInterviewClick(e) {
        const scheduleBtn = e.target.closest('.schedule-mock-btn');
        if (!scheduleBtn) return;
        
        e.preventDefault();
        const interviewId = scheduleBtn.getAttribute('data-interview-id');
        if (!interviewId) {
            console.error('No interview ID found on button');
            return;
        }
        
        console.log('Scheduling mock interview:', interviewId);
        scheduleMockInterview(interviewId);
    }

    // Add click handler to the document for event delegation
    document.addEventListener('click', handleMockInterviewClick);
    
    // Also add click handler specifically to the mock interview list in case event delegation isn't working
    const mockInterviewList = document.getElementById('mockInterviewList');
    if (mockInterviewList) {
        mockInterviewList.addEventListener('click', handleMockInterviewClick);
    }
    
    // Handle new appointment button
    document.getElementById('newAppointmentBtn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
        document.getElementById('appointmentForm').reset();
        document.getElementById('appointmentId').value = '';
        document.getElementById('deleteAppointment').classList.add('d-none');
        document.getElementById('appointmentModalLabel').textContent = 'Schedule New Appointment';
        
        // Set default times
        const now = new Date();
        const defaultStart = new Date(now.getTime() + 24 * 60 * 60 * 1000); // Tomorrow
        defaultStart.setHours(10, 0, 0, 0); // 10:00 AM
        
        const defaultEnd = new Date(defaultStart);
        defaultEnd.setHours(defaultStart.getHours() + 1); // 1 hour duration
        
        startTimePicker.setDate(defaultStart);
        endTimePicker.setDate(defaultEnd);
        
        modal.show();
    });
    
    // Handle form submission
    document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const appointmentData = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            start_time: startTimePicker.selectedDates[0].toISOString(),
            end_time: endTimePicker.selectedDates[0].toISOString(),
            location: document.getElementById('location').value,
            meeting_link: document.getElementById('meetingLink').value,
            candidate_id: document.getElementById('candidateId').value
        };
        
        const appointmentId = document.getElementById('appointmentId').value;
        const url = appointmentId ? `/api/appointments/${appointmentId}` : '/api/appointments';
        const method = appointmentId ? 'PUT' : 'POST';
        
        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(appointmentData)
            });
            
            if (!response.ok) {
                throw new Error('Failed to save appointment');
            }
            
            const result = await response.json();
            
            // Refresh calendar
            calendar.refetchEvents();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('appointmentModal'));
            modal.hide();
            
            // Show success message
            alert('Appointment saved successfully!');
            
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while saving the appointment. Please try again.');
        }
    });
    
    // Handle delete button
    document.getElementById('deleteAppointment').addEventListener('click', async function() {
        if (!confirm('Are you sure you want to delete this appointment?')) {
            return;
        }
        
        const appointmentId = document.getElementById('appointmentId').value;
        
        try {
            const response = await fetch(`/api/appointments/${appointmentId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete appointment');
            }
            
            // Refresh calendar
            calendar.refetchEvents();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('appointmentModal'));
            modal.hide();
            
            // Show success message
            alert('Appointment deleted successfully!');
            
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting the appointment. Please try again.');
        }
    });
});
</script>
{% endblock %}
